# create a coordination of the object "phylo" 

phylo_rarefy_unifrac_W = ordinate(phylo, method="PCoA", 
                                  distance="unifrac", weighted=TRUE)
# ordinate is a function in phyloseq. 
# the default method is "DCA", where it also supports "CCA", "RDA", "CAP", "DPCoA", "NMDS", "MDS", "PCoA")
# the default distance is "bray", where you can do "unifrac", "dist" etc. 
# for unifrac, the default is unweighted, which won't account for the abundance and is more useful to detect rare species.

PCoA_unifrac_W=
  plot_ordination(phylo, phylo_rarefy_unifrac_W,
                  color =  "Treatment", axes=1:2) +
  geom_point(size = 3, alpha = 1) + 
  #ggtitle("fecal") +
  #scale_color_manual(values=c (taxa_palette_mg))  +
  scale_colour_viridis_d(begin = 0,end = 0.8,option = "plasma")+
  theme_q2r() +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text = element_text(size = 12),
        axis.ticks = element_blank()) 
print(PCoA_unifrac_W)
#plot_ordination(phyloseq object,ordination object, type = "samples", axes = 1:2, color = NULL, shape = NULL, label = NULL, title = NULL)
#type could be others, e.g. "species", axes could be other components, e.g. 2:3.
#scale_colour_vividis_d()have from 0 - 1 value and that picks colours from the scale.  

#Below is the facet_wrap graph. It will make several PCoA graphs separating by one parameter.
PCoA_unifrac_W_wrap=
  plot_ordination(phylo, phylo_rarefy_unifrac_W, 
                  color =  "Treatment", shape= "Source", axes = 1:2) +
  geom_point(size = 3, alpha = 1) + 
  #ggtitle("fecal") +
  #scale_color_manual(values=taxa_palette_mg)  +
  scale_colour_viridis_d(begin = 0,end = 0.8,option = "plasma")+
  theme_q2r() +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text = element_text(size = 12),
        axis.ticks = element_blank()) +
  facet_wrap(~Source)+stat_ellipse()
print(PCoA_unifrac_W_wrap)
#stat_ellipse will draw a circle around the cluster.
## to use defined color, try: scale_color_manual(values= c("darkred","darkblue")+
#It's a better habit to define two separate variables for the wrap and not wrap. Otherwise you overwrite the first one and won't be able to make side-by-side.

#Side by side graph
require(gridExtra)
grid.arrange(PCoA_unifrac_W,  PCoA_unifrac_W_wrap, nrow=2)
